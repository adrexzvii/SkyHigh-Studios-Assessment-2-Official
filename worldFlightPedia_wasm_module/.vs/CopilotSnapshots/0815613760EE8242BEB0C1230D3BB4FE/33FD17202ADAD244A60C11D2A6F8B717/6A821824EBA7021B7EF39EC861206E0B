#include <MSFS/MSFS.h>
#include <MSFS/MSFS_WindowsTypes.h>
#include <SimConnect.h>

// ----------------------------------------------------
// Global SimConnect handle
// ----------------------------------------------------
HANDLE g_hSimConnect = 0;

// ----------------------------------------------------
// Enum para eventos del módulo
// ----------------------------------------------------
enum eEvents
{
    EVENT_FLIGHT_LOADED = 0,
    EVENT_SIM_START = 1,
    EVENT_FLIGHTPLAN_LOADED = 2
};

// ----------------------------------------------------
// Declaración de callback
// ----------------------------------------------------
void CALLBACK MyDispatchProc(SIMCONNECT_RECV* pData, DWORD cbData, void* pContext);

// ----------------------------------------------------
// INIT: conexión mínima
// ----------------------------------------------------
extern "C" MSFS_CALLBACK void module_init(void)
{
    const char* clientName = "FlightpediaConnect";
    HRESULT hr = SimConnect_Open(&g_hSimConnect, clientName, 0, 0, 0, 0);
    if (hr != S_OK)
    {
        fprintf(stderr, "[MSFS] SimConnect_Open('%s') failed (HRESULT=0x%08X)\n", clientName, static_cast<unsigned int>(hr));
        g_hSimConnect = 0;
        return;
    }

    fprintf(stderr, "[MSFS] v1 SimConnect connected as '%s'.\n", clientName);

    // Suscribirse al evento de sistema "FlightLoaded" para detectar cuando comienza un vuelo
    hr = SimConnect_SubscribeToSystemEvent(g_hSimConnect, EVENT_FLIGHT_LOADED, "FlightLoaded");
    if (hr == S_OK)
    {
        fprintf(stderr, "[MSFS] Subscribed to FlightLoaded event (id=%d)\n", EVENT_FLIGHT_LOADED);
    }
    else
    {
        fprintf(stderr, "[MSFS] Could not subscribe to FlightLoaded (HRESULT=0x%08X)\n", static_cast<unsigned int>(hr));
    }

    // Suscribirse a eventos adicionales para diagnóstico
    hr = SimConnect_SubscribeToSystemEvent(g_hSimConnect, EVENT_SIM_START, "SimStart");
    if (hr == S_OK)
    {
        fprintf(stderr, "[MSFS] Subscribed to SimStart event (id=%d)\n", EVENT_SIM_START);
    }
    else
    {
        fprintf(stderr, "[MSFS] Could not subscribe to SimStart (HRESULT=0x%08X)\n", static_cast<unsigned int>(hr));
    }

    hr = SimConnect_SubscribeToSystemEvent(g_hSimConnect, EVENT_FLIGHTPLAN_LOADED, "FlightPlanLoaded");
    if (hr == S_OK)
    {
        fprintf(stderr, "[MSFS] Subscribed to FlightPlanLoaded event (id=%d)\n", EVENT_FLIGHTPLAN_LOADED);
    }
    else
    {
        fprintf(stderr, "[MSFS] Could not subscribe to FlightPlanLoaded (HRESULT=0x%08X)\n", static_cast<unsigned int>(hr));
    }
}

// ----------------------------------------------------
// DEINIT: cierre limpio
// ----------------------------------------------------
extern "C" MSFS_CALLBACK void module_deinit(void)
{
    if (g_hSimConnect)
    {
        SimConnect_Close(g_hSimConnect);
        g_hSimConnect = 0;
        fprintf(stderr, "[MSFS] SimConnect closed.\n");
    }
}

// ----------------------------------------------------
// UPDATE: llama al dispatcher para recibir eventos
// ----------------------------------------------------
extern "C" MSFS_CALLBACK void module_update(void)
{
    if (!g_hSimConnect)
        return;

    // Log para confirmar que module_update se ejecuta y llamamos al dispatch
    fprintf(stderr, "[MSFS] module_update: calling SimConnect_CallDispatch\n");

    HRESULT hr = SimConnect_CallDispatch(g_hSimConnect, MyDispatchProc, nullptr);
    if (hr != S_OK)
    {
        // log opcional para depuración
        fprintf(stderr, "[MSFS] SimConnect_CallDispatch returned 0x%08X\n", static_cast<unsigned int>(hr));
    }
}

// ----------------------------------------------------
// DISPATCH CALLBACK
// ----------------------------------------------------
void CALLBACK MyDispatchProc(SIMCONNECT_RECV* pData, DWORD cbData, void* pContext)
{
    if (!pData)
        return;

    // Log general para saber que el dispatch se llamó
    fprintf(stderr, "[MSFS] MyDispatchProc called: dwID=0x%08X, cbData=%u\n", static_cast<unsigned int>(pData->dwID), static_cast<unsigned int>(cbData));

    switch (pData->dwID)
    {
    case SIMCONNECT_RECV_ID_EVENT_FILENAME:
    {
        SIMCONNECT_RECV_EVENT_FILENAME* evt = (SIMCONNECT_RECV_EVENT_FILENAME*)pData;
        fprintf(stderr, "[MSFS] Received EVENT_FILENAME: uEventID=%u, szFileName='%s'\n", static_cast<unsigned int>(evt->uEventID), evt->szFileName);
        switch (evt->uEventID)
        {
        case EVENT_FLIGHT_LOADED:
            fprintf(stderr, "[MSFS] FlightLoaded detected: %s\n", evt->szFileName);
            break;

        default:
            break;
        }
        break;
    }
    case SIMCONNECT_RECV_ID_EVENT:
    {
        SIMCONNECT_RECV_EVENT* evt = (SIMCONNECT_RECV_EVENT*)pData;
        fprintf(stderr, "[MSFS] Received EVENT: uEventID=%u\n", static_cast<unsigned int>(evt->uEventID));
        // Log si coincide con nuestras suscripciones
        if (evt->uEventID == EVENT_SIM_START)
        {
            fprintf(stderr, "[MSFS] SimStart event received.\n");
        }
        else if (evt->uEventID == EVENT_FLIGHTPLAN_LOADED)
        {
            fprintf(stderr, "[MSFS] FlightPlanLoaded event received.\n");
        }
        break;
    }
    default:
        fprintf(stderr, "[MSFS] Received unknown dwID=0x%08X\n", static_cast<unsigned int>(pData->dwID));
        break;
    }
}