#include <MSFS/MSFS.h>
#include <MSFS/MSFS_WindowsTypes.h>
#include <SimConnect.h>

// ----------------------------------------------------
// Global SimConnect handle
// ----------------------------------------------------
HANDLE g_hSimConnect = 0;

// ----------------------------------------------------
// Enum para eventos del módulo
// ----------------------------------------------------
enum eEvents
{
    EVENT_FLIGHT_LOADED = 0
};

// ----------------------------------------------------
// Declaración de callback
// ----------------------------------------------------
void CALLBACK MyDispatchProc(SIMCONNECT_RECV* pData, DWORD cbData, void* pContext);

// ----------------------------------------------------
// INIT: conexión mínima
// ----------------------------------------------------
extern "C" MSFS_CALLBACK void module_init(void)
{
    const char* clientName = "FlightpediaConnect";
    HRESULT hr = SimConnect_Open(&g_hSimConnect, clientName, 0, 0, 0, 0);
    if (hr != S_OK)
    {
        fprintf(stderr, "[MSFS] SimConnect_Open('%s') failed (HRESULT=0x%08X)\n", clientName, static_cast<unsigned int>(hr));
        g_hSimConnect = 0;
        return;
    }

    fprintf(stderr, "[MSFS] SimConnect connected as '%s'.\n", clientName);

    // Suscribirse al evento de sistema "FlightLoaded" para detectar cuando comienza un vuelo
    hr = SimConnect_SubscribeToSystemEvent(g_hSimConnect, EVENT_FLIGHT_LOADED, "FlightLoaded");
    if (hr != S_OK)
    {
        fprintf(stderr, "[MSFS] Could not subscribe to FlightLoaded (HRESULT=0x%08X)\n", static_cast<unsigned int>(hr));
    }
}

// ----------------------------------------------------
// DEINIT: cierre limpio
// ----------------------------------------------------
extern "C" MSFS_CALLBACK void module_deinit(void)
{
    if (g_hSimConnect)
    {
        SimConnect_Close(g_hSimConnect);
        g_hSimConnect = 0;
        fprintf(stderr, "[MSFS] SimConnect closed.\n");
    }
}

// ----------------------------------------------------
// UPDATE: llama al dispatcher para recibir eventos
// ----------------------------------------------------
extern "C" MSFS_CALLBACK void module_update(void)
{
    if (!g_hSimConnect)
        return;

    HRESULT hr = SimConnect_CallDispatch(g_hSimConnect, MyDispatchProc, nullptr);
    if (hr != S_OK)
    {
        // normalmente se ignora, registro opcional
        // fprintf(stderr, "[MSFS] CallDispatch returned 0x%08X\n", static_cast<unsigned int>(hr));
    }
}

// ----------------------------------------------------
// DISPATCH CALLBACK
// ----------------------------------------------------
void CALLBACK MyDispatchProc(SIMCONNECT_RECV* pData, DWORD cbData, void* pContext)
{
    if (!pData)
        return;

    switch (pData->dwID)
    {
    case SIMCONNECT_RECV_ID_EVENT_FILENAME:
    {
        SIMCONNECT_RECV_EVENT_FILENAME* evt = (SIMCONNECT_RECV_EVENT_FILENAME*)pData;
        switch (evt->uEventID)
        {
        case EVENT_FLIGHT_LOADED:
            fprintf(stderr, "[MSFS] FlightLoaded detected: %s\n", evt->szFileName);
            break;

        default:
            break;
        }
        break;
    }
    default:
        break;
    }
}