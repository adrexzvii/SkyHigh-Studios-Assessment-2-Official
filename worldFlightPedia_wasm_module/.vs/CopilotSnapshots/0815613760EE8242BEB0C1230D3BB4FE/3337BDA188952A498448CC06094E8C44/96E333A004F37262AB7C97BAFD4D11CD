#include <MSFS/MSFS.h>
#include <MSFS/MSFS_WindowsTypes.h>
#include <SimConnect.h>
#include "worldFlightPedia_wasm_module.h"

// ----------------------------------------------------
// Global SimConnect handle
// ----------------------------------------------------
HANDLE g_hSimConnect = 0;
static unsigned int g_frameCounter = 0; // para heartbeat
static DWORD g_lasersID = SIMCONNECT_OBJECT_ID_USER; // almacenará el id asignado al crear Lasers

// ----------------------------------------------------
// Enum para eventos del módulo
// ----------------------------------------------------
enum eEvents
{
    EVENT_FLIGHT_LOADED = 0,
    EVENT_SIM_START = 1,
    EVENT_FLIGHTPLAN_LOADED = 2,
    EVENT_TRIGGER_M = 3,
    EVENT_TRIGGER_N = 4
};

// Grupos/Inputs para MapInputEventToClientEvent
enum eGroups {
    GROUP_INPUT = 0
};

enum eInputs {
    INPUT_GROUP = 0
};

// Request IDs para operaciones asíncronas
enum eRequests {
    REQUEST_ADD_LASERS = 101,
    REQUEST_REMOVE_LASERS = 201
};

// ----------------------------------------------------
// Declaración de callback
// ----------------------------------------------------
void CALLBACK MyDispatchProc(SIMCONNECT_RECV* pData, DWORD cbData, void* pContext);

// ----------------------------------------------------
// Utilidad: spawn de SimObject
// ----------------------------------------------------
static void SpawnSimObject(double lat, double lon, double alt)
{
    if (!g_hSimConnect)
        return;

    SIMCONNECT_DATA_INITPOSITION pos = {};
    pos.Latitude = lat;
    pos.Longitude = lon;
    pos.Altitude = alt;
    pos.Pitch = 0;
    pos.Bank = 0;
    pos.Heading = 0;
    pos.OnGround = 0;

    HRESULT hr = SimConnect_AICreateSimulatedObject(g_hSimConnect, "laser_red", pos, REQUEST_ADD_LASERS);
    if (hr == S_OK)
    {
        fprintf(stderr, "[MSFS] Spawn request submitted for 'Lasers' (request=%d) at %.5f, %.5f, alt %.1f\n", REQUEST_ADD_LASERS, lat, lon, alt);
    }
    else
    {
        fprintf(stderr, "[MSFS] Spawn FAILED (HRESULT=0x%08X)\n", static_cast<unsigned int>(hr));
    }
}

// ----------------------------------------------------
// Utilidad: remove SimObject
// ----------------------------------------------------
static void RemoveLasersObject()
{
    if (!g_hSimConnect)
        return;

    if (g_lasersID == SIMCONNECT_OBJECT_ID_USER)
    {
        fprintf(stderr, "[MSFS] No known 'Lasers' object to remove.\n");
        return;
    }

    HRESULT hr = SimConnect_AIRemoveObject(g_hSimConnect, g_lasersID, REQUEST_REMOVE_LASERS);
    if (hr == S_OK)
    {
        fprintf(stderr, "[MSFS] Remove request submitted for 'Lasers' id=%u (request=%d)\n", (unsigned)g_lasersID, REQUEST_REMOVE_LASERS);
        // clear local id; object removal is requested
        g_lasersID = SIMCONNECT_OBJECT_ID_USER;
    }
    else
    {
        fprintf(stderr, "[MSFS] Remove request FAILED (HRESULT=0x%08X)\n", static_cast<unsigned int>(hr));
    }
}

// ----------------------------------------------------
// INIT: conexión mínima
// ----------------------------------------------------
extern "C" MODULE_EXPORT MSFS_CALLBACK void module_init(void)
{
    const char* clientName = "FlightpediaConnect";
    HRESULT hr = SimConnect_Open(&g_hSimConnect, clientName, 0, 0, 0, 0);
    if (hr != S_OK)
    {
        fprintf(stderr, "[MSFS] SimConnect_Open('%s') failed (HRESULT=0x%08X)\n", clientName, static_cast<unsigned int>(hr));
        g_hSimConnect = 0;
        return;
    }

    fprintf(stderr, "[MSFS] v4 SimConnect connected as '%s'.\n", clientName);

    // Suscripciones
    hr = SimConnect_SubscribeToSystemEvent(g_hSimConnect, EVENT_FLIGHT_LOADED, "FlightLoaded");
    fprintf(stderr, "[MSFS] Subscribed FlightLoaded -> %s (id=%d)\n", hr==S_OK?"OK":"FAIL", EVENT_FLIGHT_LOADED);

    hr = SimConnect_SubscribeToSystemEvent(g_hSimConnect, EVENT_SIM_START, "SimStart");
    fprintf(stderr, "[MSFS] Subscribed SimStart -> %s (id=%d)\n", hr==S_OK?"OK":"FAIL", EVENT_SIM_START);

    hr = SimConnect_SubscribeToSystemEvent(g_hSimConnect, EVENT_FLIGHTPLAN_LOADED, "FlightPlanLoaded");
    fprintf(stderr, "[MSFS] Subscribed FlightPlanLoaded -> %s (id=%d)\n", hr==S_OK?"OK":"FAIL", EVENT_FLIGHTPLAN_LOADED);

    // Mapear tecla 'M' a un evento cliente usando MapInputEventToClientEvent
    hr = SimConnect_MapClientEventToSimEvent(g_hSimConnect, EVENT_TRIGGER_M, "Flightpedia.M");
    fprintf(stderr, "[MSFS] MapClientEventToSimEvent EVENT_TRIGGER_M -> %s\n", hr==S_OK?"OK":"FAIL");

    hr = SimConnect_MapInputEventToClientEvent(g_hSimConnect, INPUT_GROUP, "M", EVENT_TRIGGER_M);
    fprintf(stderr, "[MSFS] MapInputEventToClientEvent 'M' -> %s\n", hr==S_OK?"OK":"FAIL");

    // Mapear tecla 'N' para eliminar objeto
    hr = SimConnect_MapClientEventToSimEvent(g_hSimConnect, EVENT_TRIGGER_N, "Flightpedia.N");
    fprintf(stderr, "[MSFS] MapClientEventToSimEvent EVENT_TRIGGER_N -> %s\n", hr==S_OK?"OK":"FAIL");

    hr = SimConnect_MapInputEventToClientEvent(g_hSimConnect, INPUT_GROUP, "N", EVENT_TRIGGER_N);
    fprintf(stderr, "[MSFS] MapInputEventToClientEvent 'N' -> %s\n", hr==S_OK?"OK":"FAIL");

    // Añadir los eventos cliente al grupo de notificación y activar el grupo de input
    hr = SimConnect_AddClientEventToNotificationGroup(g_hSimConnect, GROUP_INPUT, EVENT_TRIGGER_M);
    fprintf(stderr, "[MSFS] AddClientEventToNotificationGroup EVENT_TRIGGER_M -> %s\n", hr==S_OK?"OK":"FAIL");

    hr = SimConnect_AddClientEventToNotificationGroup(g_hSimConnect, GROUP_INPUT, EVENT_TRIGGER_N);
    fprintf(stderr, "[MSFS] AddClientEventToNotificationGroup EVENT_TRIGGER_N -> %s\n", hr==S_OK?"OK":"FAIL");

    hr = SimConnect_SetNotificationGroupPriority(g_hSimConnect, GROUP_INPUT, SIMCONNECT_GROUP_PRIORITY_HIGHEST);
    fprintf(stderr, "[MSFS] SetNotificationGroupPriority GROUP_INPUT -> %s\n", hr==S_OK?"OK":"FAIL");

    hr = SimConnect_SetInputGroupState(g_hSimConnect, INPUT_GROUP, SIMCONNECT_STATE_ON);
    fprintf(stderr, "[MSFS] SetInputGroupState INPUT_GROUP ON -> %s\n", hr==S_OK?"OK":"FAIL");

    // Try an initial dispatch to flush any pending messages
    hr = SimConnect_CallDispatch(g_hSimConnect, MyDispatchProc, nullptr);
    if (hr != S_OK)
    {
        fprintf(stderr, "[MSFS] SimConnect_CallDispatch on INIT returned 0x%08X\n", static_cast<unsigned int>(hr));
    }
    else
    {
        fprintf(stderr, "[MSFS] SimConnect_CallDispatch on INIT\n");
    }
}

// ----------------------------------------------------
// DEINIT: cierre limpio
// ----------------------------------------------------
extern "C" MODULE_EXPORT MSFS_CALLBACK void module_deinit(void)
{
    if (g_hSimConnect)
    {
        // Turn off input group
        SimConnect_SetInputGroupState(g_hSimConnect, INPUT_GROUP, SIMCONNECT_STATE_OFF);

        SimConnect_Close(g_hSimConnect);
        g_hSimConnect = 0;
        fprintf(stderr, "[MSFS] SimConnect closed.\n");
    }
}

// ----------------------------------------------------
// DISPATCH CALLBACK
// ----------------------------------------------------
void CALLBACK MyDispatchProc(SIMCONNECT_RECV* pData, DWORD cbData, void* pContext)
{
    if (!pData)
        return;

    switch (pData->dwID)
    {
    case SIMCONNECT_RECV_ID_EVENT_FILENAME:
    {
        SIMCONNECT_RECV_EVENT_FILENAME* evt = (SIMCONNECT_RECV_EVENT_FILENAME*)pData;
        if (evt->uEventID == EVENT_FLIGHT_LOADED)
        {
            fprintf(stderr, "[MSFS] FlightLoaded detected: %s\n", evt->szFileName);
        }
        else
        {
            fprintf(stderr, "[MSFS] EVENT_FILENAME other id=%u file='%s'\n", (unsigned)evt->uEventID, evt->szFileName);
        }
        break;
    }
    case SIMCONNECT_RECV_ID_EVENT:
    {
        SIMCONNECT_RECV_EVENT* evt = (SIMCONNECT_RECV_EVENT*)pData;
        if (evt->uEventID == EVENT_SIM_START)
        {
            fprintf(stderr, "[MSFS] SimStart event received.\n");
        }
        else if (evt->uEventID == EVENT_FLIGHTPLAN_LOADED)
        {
            fprintf(stderr, "[MSFS] FlightPlanLoaded event received.\n");
        }
        else if (evt->uEventID == EVENT_TRIGGER_M)
        {
            // Cuando el usuario presiona 'M' se mapeará aquí
            fprintf(stderr, "[MSFS][ERROR] Key 'M' pressed - triggered EVENT_TRIGGER_M\n");
            // Spawn Lasers at Cochabamba example coordinates
            SpawnSimObject(-17.389, -66.156, 2600.0);
        }
        else if (evt->uEventID == EVENT_TRIGGER_N)
        {
            fprintf(stderr, "[MSFS][ERROR] Key 'N' pressed - triggered EVENT_TRIGGER_N\n");
            // Remove Lasers object
            RemoveLasersObject();
        }
        else
        {
            fprintf(stderr, "[MSFS] EVENT generic id=%u\n", (unsigned)evt->uEventID);
        }
        break;
    }
    case SIMCONNECT_RECV_ID_ASSIGNED_OBJECT_ID:
    {
        SIMCONNECT_RECV_ASSIGNED_OBJECT_ID* pObj = (SIMCONNECT_RECV_ASSIGNED_OBJECT_ID*)pData;
        if (pObj->dwRequestID == REQUEST_ADD_LASERS)
        {
            g_lasersID = pObj->dwObjectID;
            fprintf(stderr, "[MSFS] Assigned object id for 'Lasers' = %u (request=%u)\n", (unsigned)g_lasersID, (unsigned)pObj->dwRequestID);
        }
        else
        {
            fprintf(stderr, "[MSFS] Assigned object id for request %u = %u\n", (unsigned)pObj->dwRequestID, (unsigned)pObj->dwObjectID);
        }
        break;
    }
    default:
        // Otros paquetes ignorados
        break;
    }
}